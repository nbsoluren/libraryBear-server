{"version":3,"sources":["../../src/api/library.js"],"names":["db","req","res","params","body","queryResult","parameters","queryString","title","replace","getIdSource","values","query","err","rows","console","log","json","fulfillmentText","length","id","rows1","createFulfillmentSuggestions","text","suggestions","returnBook","books","i","author","category","pushCards","showBorrowedBooks","array","ID","source","name","givenname","getStarted","checkUser","borrowBook","searchBooks","searchBooksByAuthor","searchBooksByCategory","searchBooksByTitle","showAllBooks","showAllAvailableBooks","pushNotif","payload","url","pageAccessToken","headers","method","JSON","stringify","catch","e","pushMessage","message","messaging_type","recipient","pushQuickReplies","replies","quick_replies","map","content_type","reply","cards","showAvailability","Promise","resolve","reject","attachment","type","template_type","elements","splicedCards","splice","availablity","borrower","push","subtitle","image_url","image","buttons","originalDetectIntentRequest","hasOwnProperty","data","sender","session","checkFacebookUserId","currId","eer","createFulfillmentCardSuggestions","imageUri","fulfillmentMessages","platform","simpleResponses","textToSpeech","basicCard","accessibilityText","suggestion","card","quickReplies","hasTitle","hasAuthor","hasCategory","availability"],"mappings":"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","file":"library.js","sourcesContent":["import fetch from 'node-fetch';\n\nfunction pushNotif(id, payload) {\n\tconst url = 'https://graph.facebook.com/v2.6/me/messages?access_token=';\n\tconst pageAccessToken = 'EAAdaLXIFrz8BAI5jbBbAfBrV03Yl6TnFsvpqKsvfVdUZAkGO93ZCv0YRHfVrUAu1cd1vkK3J6fJNKnjYZByZAQsSC2y7hgXCfHuPxoDMqZCkNlpCpwGMAOA2UeDvkzyxxUhbPyyrSeTx9fiZCRBfP0bI0rRA1bTEWfAhqZB4uMPeM03ZAnSF5QkA'\n\t\n\tfetch(url + pageAccessToken, {\n\t\theaders: { 'Content-Type': 'application/json' },\n\t\tmethod: \"POST\",\n\t\tbody: JSON.stringify(payload)\t  \t\n\t})\n\t\t.catch((e) => { console.log(e); });\n}\n\nfunction pushMessage(id, message) {\n\tpushNotif(id, {\n\t\tmessaging_type: 'UPDATE',\n\t\trecipient: {\n\t\t\tid: id\n\t\t},\n\t\tmessage: {\n\t\t\ttext: message\n\t\t}\n\t})\n}\n\nfunction pushQuickReplies(id, text, replies) {\n\tpushNotif(id, {\n\t\tmessaging_type: 'UPDATE',\n\t\trecipient: {\n\t\t\tid: id\n\t\t},\n\t\tmessage: {\n\t\t\ttext: text,\n\t\t\tquick_replies: replies.map(reply => {\n\t\t\t\treturn {\n\t\t\t\t\tcontent_type: 'text',\n\t\t\t\t\ttitle: reply,\n\t\t\t\t\tpayload: reply\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t});\n}\n\nfunction pushCards(id, cards, showAvailability=false) {\n\treturn new Promise((resolve, reject) => {\n\t\tvar payload = {\n\t\t\trecipient: {\n\t\t\t\tid: id\n\t\t\t},\n\t\t\tmessage: {\n\t\t\t\tattachment: {\n\t\t\t\t\ttype: 'template',\n\t\t\t\t\tpayload: {\n\t\t\t\t\t\ttemplate_type:'generic',\n\t\t\t\t\t\telements:[]\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\tvar splicedCards;\n\t\twhile(cards.length)\t{\n\t\t\tsplicedCards = cards.splice(0, 9);\n\t\t\tpayload.message.attachment.payload.elements = [];\n\t\t\t\n\t\t\tvar availablity;\n\t\t\tfor(var i = 0; i < splicedCards.length; i++) {\n\t\t\t\tif(showAvailability && splicedCards[i].borrower != id) {\n\t\t\t\t\tif(splicedCards[i].borrower) {\n\t\t\t\t\t\tavailablity = '; Unavailable';\n\t\t\t\t\t} else {\n\t\t\t\t\t\tavailablity = '; Available';\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tavailablity = '';\n\t\t\t\t}\n\n\t\t\t\tpayload.message.attachment.payload.elements.push({\n\t\t\t\t\ttitle: splicedCards[i].title + ' by ' + splicedCards[i].author,\n\t\t\t\t\tsubtitle: splicedCards[i].category + availablity,\n\t\t\t\t\timage_url: splicedCards[i].image,\n\t\t\t\t\tbuttons:[\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: 'postback',\n\t\t\t\t\t\t\ttitle: (splicedCards[i].borrower != id? 'Borrow ' : 'Return '),\n\t\t\t\t\t\t\tpayload: (splicedCards[i].borrower != id? 'Borrow ' : 'Return ') + ' ' + splicedCards[i].title + ' book'\n\t\t\t\t\t\t}              \n\t\t\t\t\t]      \n\t\t\t\t});\n\t\t\t}\n\t\t\tpushNotif(id, payload);\n\t\t}\n\t\treturn resolve();\n\t});\n}\n\nfunction getIdSource(req) {\n\treturn new Promise((resolve, reject) => {\n\t\tif(req.body.originalDetectIntentRequest.hasOwnProperty('source') && req.body.originalDetectIntentRequest.source == 'facebook') {\n\t\t\tconst source = req.body.originalDetectIntentRequest.source;\n\t\t\tconst id = req.body.originalDetectIntentRequest.payload.data.sender.id;\n\t\t\treturn resolve([id, source]);\n\t\t} else {\n\t\t\tconst source = 'DialogFlow';\n\t\t\tconst id = req.body.session;\n\t\t\treturn resolve([id, source]);\n\t\t}\n\t})\n}\n\nfunction checkFacebookUserId(db, currId, id){\n\treturn new Promise((resolve, reject) => {\t\t\n\t\tconst queryString = 'SELECT source FROM user WHERE id = ? AND id != ?';\n\t\tconst values = [id, currId];\n\n\t\tdb.query(queryString, values, (err, rows) => {\n\t\t\tif(err) {\n\t\t\t\tconsole.log(eer);\n\t\t\t\treturn resolve(false);\n\t\t\t} else {\n\t\t\t\tif(rows.length && rows[0].source == 'facebook'){\n\t\t\t\t\treturn resolve(true);\n\t\t\t\t} else {\n\t\t\t\t\treturn resolve(false);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t});\n}\n\nfunction createFulfillmentCardSuggestions({ text, imageUri, title, subtitle, suggestions }) {\n\treturn {\n\t\tfulfillmentMessages: [\n            {\n\t\t\t\tplatform: 'ACTIONS_ON_GOOGLE',\n            \tsimpleResponses: {\n\t\t\t\t\tsimpleResponses: [{\n\t\t\t\t\t\ttextToSpeech: text\n\t\t\t\t\t}]\n\t\t\t\t}\n            },\n\t\t\t{\n\t\t\t\tplatform: 'ACTIONS_ON_GOOGLE',\n\t\t\t\tbasicCard: {\n\t\t\t\t\ttitle: title,\n\t\t\t\t\tsubtitle: subtitle,\n\t\t\t\t\timage: {\n\t\t\t\t\t\timageUri: imageUri,\n\t\t\t\t\t\taccessibilityText: 'Cannot load image.'\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\t{\n\t\t\t\tplatform: 'ACTIONS_ON_GOOGLE',\n\t\t\t\tsuggestions: {\n\t\t\t\t\tsuggestions: suggestions.map(suggestion => { return { title: suggestion } })\n\t\t\t\t}\n\t\t\t},\n\t\t\t{\n\t\t\t\tcard: {\n\t\t\t\t\ttitle: title,\n\t\t\t\t\tsubtitle: subtitle,\n\t\t\t\t\timageUri: imageUri\n\t\t\t\t},\n\t\t\t\tplatform: 'FACEBOOK'\n\t\t\t},\n\t\t\t{\n\t\t\t\tquickReplies: {\n\t\t\t\t\ttitle: text,\n\t\t\t\t\tquickReplies: suggestions\n\t\t\t\t},\n\t\t\t\tplatform: 'FACEBOOK'\n\t\t\t},\n\t\t\t{\n\t\t\t\ttext: {\n\t\t\t\t\ttext: [text]\n\t\t\t\t}\n\t\t\t}\n\t\t]\n\t}\n}\n\nfunction createFulfillmentSuggestions({ text, suggestions }) {\n\treturn {\n\t\tfulfillmentMessages: [\n            {\n\t\t\t\tplatform: 'ACTIONS_ON_GOOGLE',\n            \tsimpleResponses: {\n\t\t\t\t\tsimpleResponses: [{\n\t\t\t\t\t\ttextToSpeech: text\n\t\t\t\t\t}]\n\t\t\t\t}\n            },\n\t\t\t{\n\t\t\t\tplatform: 'ACTIONS_ON_GOOGLE',\n\t\t\t\tsuggestions: {\n\t\t\t\t\tsuggestions: suggestions.map(suggestion => { return { title: suggestion } })\n\t\t\t\t}\n\t\t\t},\n\t\t\t{\n\t\t\t\tquickReplies: {\n\t\t\t\t\ttitle: text,\n\t\t\t\t\tquickReplies: suggestions\n\t\t\t\t},\n\t\t\t\tplatform: 'FACEBOOK'\n\t\t\t},\n\t\t\t{\n\t\t\t\ttext: {\n\t\t\t\t\ttext: [text]\n\t\t\t\t}\n\t\t\t}\n\t\t]\n\t}\n}\n\nexport function checkUser(db, req, res) {\n\treturn new Promise(async (resolve, reject) => {\n\t\tconst data = await getIdSource(req);\n\t\tconst id = data[0];\n\t\tconst source = data[1];\n\n\t\tvar queryString = 'SELECT id FROM user WHERE BINARY id = ?';\n\n\t\tdb.query(queryString, id, (err, rows) => {\n\t\t\tif(err) {\n\t\t\t\tconsole.log(err);\n\t\t\t\treturn reject();\n\t\t\t} else {\n\t\t\t\tif(!rows.length) {\n\t\t\t\t\tqueryString = 'INSERT INTO user(id,source,prev_transac) VALUES (?, ?, NOW())';\n\t\t\t\t\tconst values = [id, source];\n\n\t\t\t\t\tdb.query(queryString, values, (err, rows) => {\n\t\t\t\t\t\tif(err) {\n\t\t\t\t\t\t\tconsole.log(err);\n\t\t\t\t\t\t\treturn reject();\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\treturn resolve();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tqueryString = 'UPDATE user SET prev_transac = NOW() WHERE id = ?'\n\t\t\t\t\t\n\t\t\t\t\tdb.query(queryString, id, (err, rows) => {\n\t\t\t\t\t\tif(err) {\n\t\t\t\t\t\t\tconsole.log(err);\n\t\t\t\t\t\t\treturn reject();\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\treturn resolve();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t});\n}\n\n// export function notifyUserReturnBook(db, req, res) {\n// \tconst params = req.body.queryResult.outputContexts[0].parameters;\n// \tconst notification = 'Another person wants to borrow the book ' + params.bookTitle + ', please return it immediately after use 📖\\n\\nThank you! 😁';\n// \tpushQuickReplies(params.id, notification, ['Return ' + params.bookTitle]);\n// \treturn res.json({ fulfillmentText: 'The borrower has now been notified 🔔😁' });\n// }\n\nexport function borrowBook(db, req, res) {\n\tconst params = req.body.queryResult.parameters;\n\tvar queryString = 'SELECT * FROM book WHERE title RLIKE ? ORDER BY title LIMIT 1';\n\n\tdb.query(queryString, '[[:<:]]' + params.title.replace('(', '\\\\(') + '[[:>:]]', async (err, rows) => {\n\t\tif(err) {\n\t\t\tconsole.log(err);\n\t\t\treturn res.json({ fulfillmentText: 'We will get back to you on this.' });\n\t\t}\n\n\t\tif(!rows.length) {\n\t\t\treturn res.json({ fulfillmentText: 'Sorry we currently dont have that book in the library. 😖' });\n\t\t}\n\n\t\tif(rows[0].borrower) {\n\t\t\t\treturn res.json({ fulfillmentText: 'Someone is currently borrowing that book, Sorry 😰' });\n\t\t} else {\n\n\t\t\tqueryString = 'UPDATE book SET borrower = ? WHERE title RLIKE ? ORDER BY title LIMIT 1';\n\t\t\tconst data = await getIdSource(req);\n\t\t\tconst values = [data[0], '[[:<:]]' + params.title.replace('(', '\\\\(') + '[[:>:]]'];\n\n\t\t\tdb.query(queryString, values, (err, rows1) => {\n\t\t\t\tif(err) {\n\t\t\t\t\tconsole.log(err);\n\t\t\t\t\treturn res.json({ fulfillmentText: 'We will get back to you on this.'  });\n\t\t\t\t}\n\t\t\t\n\t\t\t\t\n\t\t\t\treturn res.json(createFulfillmentCardSuggestions({\n\t\t\t\t\ttext: 'You\\'ve succesfully borrowed a book!',\n\t\t\t\t\timageUri: rows[0].image,\n\t\t\t\t\ttitle: rows[0].title + ' by ' + rows[0].author,\n\t\t\t\t\tsubtitle: rows[0].category,\n\t\t\t\t\tsuggestions: ['Borrow another book', 'Return ' + rows[0].title]\n\t\t\t\t}));\n\t\t\t});\n\t\t}\n\t});\n}\n\nexport async function returnBook(db, req, res) {\n\tconst params = req.body.queryResult.parameters;\n\tvar queryString = 'SELECT id, title FROM book WHERE title RLIKE ? AND borrower = ? ORDER BY title LIMIT 1';\n\tconst values = ['[[:<:]]' + params.title.replace('(', '\\\\(') + '[[:>:]]', (await getIdSource(req))[0]];\n\n\tdb.query(queryString, values, (err, rows) => {\n\t\tif(err) {\n\t\t\tconsole.log(err);\n\t\t\treturn res.json({ fulfillmentText: 'We will get back to you on this.' });\n\t\t}\n\n\t\tif(!rows.length) {\n\t\t\treturn res.json({ fulfillmentText: 'You can\\'t return a book you didn\\'t borrow. 😡' });\n\t\t}\n\n\t\tqueryString = 'UPDATE book SET borrower = null WHERE id = ? ORDER BY title LIMIT 1';\n\t\t\n\t\tdb.query(queryString, rows[0].id, (err, rows1) => {\n\t\t\tif(err) {\n\t\t\t\tconsole.log(err);\n\t\t\t\treturn res.json({ fulfillmentText: 'Internal Error, We will get back to you on this.' });\n\t\t\t}\n\n\t\t\treturn res.json(createFulfillmentSuggestions({\n\t\t\t\ttext: 'Succesfully returned' + rows[0].title + '. 🤗',\n\t\t\t\tsuggestions: ['Borrow another book', 'Show borrowed books']\n\t\t\t}));\n\t\t});\n\t});\n}\n\nexport function searchBooks(db, req, res) {\n\tconst params = req.body.queryResult.parameters;\n\tconst hasTitle = params.title != '';\n\tconst hasAuthor = params.author != '';\n\tconst hasCategory = params.category != '';\n\tvar queryString;\n\tvar values;\n\n\tif(hasTitle && hasAuthor && hasCategory) {\n\t\tqueryString = 'SELECT * FROM book WHERE title RLIKE ? AND author RLIKE ? AND category RLIKE ? ORDER BY title';\n\t\tvalues = ['[[:<:]]' + params.title.replace('(', '\\\\(') + '[[:>:]]', '[[:<:]]' + params.author.replace('(', '\\\\(') + '[[:>:]]', '[[:<:]]' + params.category.replace('(', '\\\\(') + '[[:>:]]'];\n\t} else if(hasTitle && hasAuthor) {\n\t\tqueryString = 'SELECT * FROM book WHERE title RLIKE ? AND author RLIKE ? ORDER BY title';\n\t\tvalues = ['[[:<:]]' + params.title.replace('(', '\\\\(') + '[[:>:]]', '[[:<:]]' + params.author.replace('(', '\\\\(') + '[[:>:]]'];\n\t} else if(hasTitle && hasCategory) {\n\t\tqueryString = 'SELECT * FROM book WHERE title RLIKE ? AND category RLIKE ? ORDER BY title';\n\t\tvalues = ['[[:<:]]' + params.title.replace('(', '\\\\(') + '[[:>:]]', '[[:<:]]' + params.category.replace('(', '\\\\(') + '[[:>:]]'];\n\t} else if(hasAuthor && hasCategory) {\n\t\tqueryString = 'SELECT * FROM book WHERE author RLIKE ? AND category RLIKE ? ORDER BY title';\n\t\tvalues = ['[[:<:]]' + params.author.replace('(', '\\\\(') + '[[:>:]]', '[[:<:]]' + params.category.replace('(', '\\\\(') + '[[:>:]]'];\n\t}\n\n\tif(queryString && values) {\n\t\tdb.query(queryString, values, async (err, rows) => {\n\t\t\tif(err) {\n\t\t\t\tconsole.log(err);\n\t\t\t\treturn res.json({ fulfillmentText: 'Hmm. I might have misunderstood that 👾 Please say it more properly 😁' });\n\t\t\t}\n\n\t\t\tif(!rows.length) {\n\t\t\t\treturn res.json({ fulfillmentText: 'That book is nowhere to be found 🤷‍♀️' });\n\t\t\t}\n\n\t\t\tvar books = 'Here are the books:\\n✅ Available 🚫 Taken';\n\t\t\tvar availability;\n\t\t\tfor(var i = 0; i < rows.length; i++) {\n\t\t\t\tavailability = rows[i].borrower? '🚫' : '✅';\n\t\t\t\tbooks += '\\n\\n' + availability + ' ' + rows[i].title + '\\nAuthor: ' + rows[i].author + '\\nCategory: ' + rows[i].category;\n\t\t\t}\n\n\t\t\tawait pushCards((await getIdSource(req))[0], rows, true);\n\n\t\t\treturn res.json({ fulfillmentText: 'Here are the books 😁' });\n\t\t});\n\t} else {\n\t\treturn res.json({ fulfillmentText: 'Hmm. I might have misunderstood that 👾 Please say it more properly 😁' });\n\t}\n}\n\nexport function searchBooksByAuthor(db, req, res) {\n\tconst author = req.body.queryResult.parameters.author;\n\tconst queryString = 'SELECT * FROM book WHERE author RLIKE ? ORDER BY title';\n\n\tdb.query(queryString, '[[:<:]]' + author.replace('(', '\\\\(') + '[[:>:]]', async (err, rows) => {\n\t\tif(err) {\n\t\t\tconsole.log(err);\n\t\t\treturn res.json({ fulfillmentText: 'Hmm. I might have misunderstood that 👾 Please say it more properly 😁' });\n\t\t}\n\n\t\tif(!rows.length) {\n\t\t\treturn res.json({ fulfillmentText: 'That book is nowhere to be found 🤷‍♀️' });\n\t\t}\n\n\t\tvar books = 'Here are the books:\\n✅ Available 🚫 Taken';\n\t\tvar availability;\n\t\tfor(var i = 0; i < rows.length; i++) {\n\t\t\tavailability = rows[i].borrower? '🚫' : '✅';\n\t\t\tbooks += '\\n\\n' + availability + ' ' + rows[i].title + '\\nAuthor: ' + rows[i].author + '\\nCategory: ' + rows[i].category;\n\t\t}\n\n\t\tawait pushCards((await getIdSource(req))[0], rows, true);\n\n\t\treturn res.json({ fulfillmentText: 'Here are the books 😁' });\n\t});\n}\n\nexport function searchBooksByCategory(db, req, res) {\n\tconst category = req.body.queryResult.parameters.category;\n\tconst queryString = 'SELECT * FROM book WHERE category RLIKE ? ORDER BY title';\n\n\tdb.query(queryString, '[[:<:]]' + category.replace('(', '\\\\(') + '[[:>:]]', async (err, rows) => {\n\t\tif(err) {\n\t\t\tconsole.log(err);\n\t\t\treturn res.json({ fulfillmentText: 'Hmm. I might have misunderstood that 👾 Please say it more properly 😁' });\n\t\t}\n\n\t\tif(!rows.length) {\n\t\t\treturn res.json({ fulfillmentText: 'That book is nowhere to be found 🤷‍♀️' });\n\t\t}\n\n\t\tvar books = 'Here are the books:\\n✅ Available 🚫 Taken';\n\t\tvar availability;\n\t\tfor(var i = 0; i < rows.length; i++) {\n\t\t\tavailability = rows[i].borrower? '🚫' : '✅';\n\t\t\tbooks += '\\n\\n' + availability + ' ' + rows[i].title + '\\nAuthor: ' + rows[i].author + '\\nCategory: ' + rows[i].category;\n\t\t}\n\t\t\n\t\tawait pushCards((await getIdSource(req))[0], rows, true);\n\n\t\treturn res.json({ fulfillmentText: 'Here are the books 😁' });\n\t});\n}\n\nexport function searchBooksByTitle(db, req, res) {\n\tconst title = req.body.queryResult.parameters.title;\n\tconst queryString = 'SELECT * FROM book WHERE title RLIKE ? ORDER BY title';\n\n\tdb.query(queryString, '[[:<:]]' + title.replace('(', '\\\\(') + '[[:>:]]', async (err, rows) => {\n\t\tif(err) {\n\t\t\tconsole.log(err);\n\t\t\treturn res.json({ fulfillmentText: 'Hmm. I might have misunderstood that 👾 Please say it more properly 😁' });\n\t\t}\n\n\t\tif(!rows.length) {\n\t\t\treturn res.json({ fulfillmentText: 'That book is nowhere to be found 🤷‍♀️' });\n\t\t}\n\n\t\tvar books = 'Here are the books:\\n✅ Available 🚫 Taken';\n\t\tvar availability;\n\t\tfor(var i = 0; i < rows.length; i++) {\n\t\t\tavailability = rows[i].borrower? '🚫' : '✅';\n\t\t\tbooks += '\\n\\n' + availability + ' ' + rows[i].title + '\\nAuthor: ' + rows[i].author + '\\nCategory: ' + rows[i].category;\n\t\t}\n\n\t\tawait pushCards((await getIdSource(req))[0], rows, true);\n\n\t\treturn res.json({ fulfillmentText: 'Here are the books 😁' });\n\t});\n}\n\nexport function showAllBooks(db, req, res) {\n\tconst queryString = 'SELECT * FROM book ORDER BY title';\n\n\tdb.query(queryString, async (err, rows) => {\n\t\tif(err) {\n\t\t\tconsole.log(err);\n\t\t\treturn res.json({ fulfillmentText: 'Hmm. I might have misunderstood that 👾 Please say it more properly 😁' });\n\t\t}\n\n\t\tif(!rows.length) {\n\t\t\treturn res.json({ fulfillmentText: 'There are currently no books 🤷‍️' });\n\t\t}\n\n\t\tvar books = 'Here are the books:\\n✅ Available 🚫 Taken';\n\t\tvar availability;\n\t\tfor(var i = 0; i < rows.length; i++) {\n\t\t\tavailability = rows[i].borrower? '🚫' : '✅';\n\t\t\tbooks += '\\n\\n' + availability + ' ' + rows[i].title + '\\nAuthor: ' + rows[i].author + '\\nCategory: ' + rows[i].category;\n\t\t}\n\n\t\tawait pushCards((await getIdSource(req))[0], rows, true);\n\n\t\treturn res.json({ fulfillmentText: 'Here are all the books 😁' });\n\t});\n}\n\nexport function showAllAvailableBooks(db, req, res) {\n\tconst queryString = 'SELECT * FROM book WHERE borrower IS NULL ORDER BY title';\n\n\tdb.query(queryString, async (err, rows) => {\n\t\tif(err) {\n\t\t\tconsole.log(err);\n\t\t\treturn res.json({ fulfillmentText: 'Hmm. I might have misunderstood that 👾 Please say it more properly 😁' });\n\t\t}\n\n\t\tif(!rows.length) {\n\t\t\treturn res.json({ fulfillmentText: 'There are currently no available books 🤷‍️' });\n\t\t}\n\n\t\tvar books = 'Here are the available books:';\n\t\tfor(var i = 0; i < rows.length; i++) {\n\t\t\tbooks += '\\n\\n' + rows[i].title + '\\nAuthor: ' + rows[i].author + '\\nCategory: ' + rows[i].category;\n\t\t}\n\n\t\tawait pushCards((await getIdSource(req))[0], rows);\n\n\t\treturn res.json({ fulfillmentText: 'Here are the available books 😁' });\n\t});\n}\n\nexport async function showBorrowedBooks(db, req, res) {\n\tconst id = (await getIdSource(req))[0];\n\tconst queryString = 'SELECT * FROM book WHERE borrower = ? ORDER BY title';\n\n\tdb.query(queryString, id, async (err, rows) => {\n\t\tif(err) {\n\t\t\tconsole.log(err);\n\t\t\treturn res.json({ fulfillmentText: 'Hmm. I might have misunderstood that 👾 Please say it more properly 😁' });\n\t\t}\n\n\t\tif(!rows.length) {\n\t\t\treturn res.json({ fulfillmentText: 'You didn\\'t borrow any book 🤷‍️' });\n\t\t}\n\n\t\tvar books = 'Here are your borrowed books:';\n\t\tfor(var i = 0; i < rows.length; i++) {\n\t\t\tbooks += '\\n\\n' + rows[i].title + '\\nAuthor: ' + rows[i].author + '\\nCategory: ' + rows[i].category;\n\t\t}\n\n\t\tawait pushCards((await getIdSource(req))[0], rows);\n\t\t\n\t\treturn res.json({ fulfillmentText: 'Here are your borrowed books 😁' });\n\t});\n}\n\nexport async function getStarted(db, req, res) {\n\tconst array = await getIdSource(req);\n\tconst ID = array[0];\n\tconst source = array[1];\n\tconst name = req.body.queryResult.parameters.givenname;\n\tconst values = [ID,name+'',source,name+''];\n\n\n\tconst queryString = 'INSERT INTO user(id, name, source, prev_transac) VALUES(?, ?, ?, NOW()) ON DUPLICATE KEY UPDATE name = ?;';\n\t\tdb.query(queryString, values, (err, rows) => {\n\t\t\tif(err) {\n\t\t\n\t\t\t\tconsole.log(err);\n\t\t\t\treturn res.json({ fulfillmentText: 'An internal error has occured. I\\'m deeply sorry about this' });\n\t\t\t}\n\t\t\t\n\t\t\treturn res.json({ \"fulfillmentText\": 'Wow. Nice to meet you! '+name});\n\t\t});\n}"]}