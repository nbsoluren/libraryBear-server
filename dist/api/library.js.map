{"version":3,"sources":["../../src/api/library.js"],"names":["db","req","res","params","body","queryResult","parameters","queryString","title","replace","getIdSource","values","query","err","rows","console","log","json","fulfillmentText","length","id","rows1","createFulfillmentSuggestions","text","suggestions","returnBook","books","i","author","category","pushCards","showBorrowedBooks","checkUser","borrowBook","searchBooks","searchBooksByAuthor","searchBooksByCategory","searchBooksByTitle","showAllBooks","showAllAvailableBooks","getStarted","pushNotif","payload","url","pageAccessToken","headers","method","JSON","stringify","catch","e","pushMessage","message","messaging_type","recipient","pushQuickReplies","replies","quick_replies","map","content_type","reply","cards","showAvailability","Promise","resolve","reject","attachment","type","template_type","elements","splicedCards","splice","availablity","borrower","push","subtitle","image_url","image","buttons","originalDetectIntentRequest","hasOwnProperty","source","data","sender","session","checkFacebookUserId","currId","eer","createFulfillmentCardSuggestions","imageUri","fulfillmentMessages","platform","simpleResponses","textToSpeech","basicCard","accessibilityText","suggestion","card","quickReplies","hasTitle","hasAuthor","hasCategory","availability","ID","name","givenname"],"mappings":";;;;;;;;qEAkTO,kBAA0BA,EAA1B,EAA8BC,GAA9B,EAAmCC,GAAnC;AAAA;AAAA;AAAA;AAAA;AAAA;AACAC,YADA,GACSF,IAAIG,IAAJ,CAASC,WAAT,CAAqBC,UAD9B;AAEFC,iBAFE,GAEY,wFAFZ;AAAA,qBAGU,YAAYJ,OAAOK,KAAP,CAAaC,OAAb,CAAqB,GAArB,EAA0B,KAA1B,CAAZ,GAA+C,SAHzD;AAAA;AAAA,aAG2EC,YAAYT,GAAZ,CAH3E;;AAAA;AAAA,oCAG6F,CAH7F;AAGAU,YAHA;;;AAKNX,SAAGY,KAAH,CAASL,WAAT,EAAsBI,MAAtB,EAA8B,UAACE,GAAD,EAAMC,IAAN,EAAe;AAC5C,WAAGD,GAAH,EAAQ;AACPE,gBAAQC,GAAR,CAAYH,GAAZ;AACA,eAAOX,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,kCAAnB,EAAT,CAAP;AACA;;AAED,WAAG,CAACJ,KAAKK,MAAT,EAAiB;AAChB,eAAOjB,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,iDAAnB,EAAT,CAAP;AACA;;AAEDX,qBAAc,qEAAd;;AAEAP,UAAGY,KAAH,CAASL,WAAT,EAAsBO,KAAK,CAAL,EAAQM,EAA9B,EAAkC,UAACP,GAAD,EAAMQ,KAAN,EAAgB;AACjD,YAAGR,GAAH,EAAQ;AACPE,iBAAQC,GAAR,CAAYH,GAAZ;AACA,gBAAOX,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,kDAAnB,EAAT,CAAP;AACA;;AAED,eAAOhB,IAAIe,IAAJ,CAASK,6BAA6B;AAC5CC,eAAM,yBAAyBT,KAAK,CAAL,EAAQN,KAAjC,GAAyC,MADH;AAE5CgB,sBAAa,CAAC,qBAAD,EAAwB,qBAAxB;AAF+B,SAA7B,CAAT,CAAP;AAIA,QAVD;AAWA,OAvBD;;AALM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,E;;iBAAeC,U;;;;;;sEAmNf,mBAAiCzB,EAAjC,EAAqCC,GAArC,EAA0CC,GAA1C;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,aACYQ,YAAYT,GAAZ,CADZ;;AAAA;AACAmB,QADA,mBAC8B,CAD9B;AAEAb,iBAFA,GAEc,sDAFd;;;AAINP,SAAGY,KAAH,CAASL,WAAT,EAAsBa,EAAtB;AAAA,4EAA0B,mBAAOP,GAAP,EAAYC,IAAZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iBACtBD,GADsB;AAAA;AAAA;AAAA;;AAExBE,oBAAQC,GAAR,CAAYH,GAAZ;AAFwB,+CAGjBX,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,wEAAnB,EAAT,CAHiB;;AAAA;AAAA,gBAMrBJ,KAAKK,MANgB;AAAA;AAAA;AAAA;;AAAA,+CAOjBjB,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,kCAAnB,EAAT,CAPiB;;AAAA;AAUrBQ,iBAVqB,GAUb,+BAVa;;AAWzB,iBAAQC,CAAR,GAAY,CAAZ,EAAeA,IAAIb,KAAKK,MAAxB,EAAgCQ,GAAhC,EAAqC;AACpCD,sBAAS,SAASZ,KAAKa,CAAL,EAAQnB,KAAjB,GAAyB,YAAzB,GAAwCM,KAAKa,CAAL,EAAQC,MAAhD,GAAyD,cAAzD,GAA0Ed,KAAKa,CAAL,EAAQE,QAA3F;AACA;;AAbwB,4BAenBC,SAfmB;AAAA;AAAA,mBAeFpB,YAAYT,GAAZ,CAfE;;AAAA;AAAA,4CAegB,CAfhB;AAAA,4BAeoBa,IAfpB;AAAA;AAAA;;AAAA;AAAA,+CAiBlBZ,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,iCAAnB,EAAT,CAjBkB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,QAA1B;;AAAA;AAAA;AAAA;AAAA;;AAJM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,E;;iBAAea,iB;;;;;QA7SNC,S,GAAAA,S;QAiDAC,U,GAAAA,U;QAwEAC,W,GAAAA,W;QAiDAC,mB,GAAAA,mB;QA2BAC,qB,GAAAA,qB;QA2BAC,kB,GAAAA,kB;QA2BAC,Y,GAAAA,Y;QA0BAC,qB,GAAAA,qB;QAiDAC,U,GAAAA,U;;AA9hBhB;;;;;;;;AAEA,SAASC,SAAT,CAAmBrB,EAAnB,EAAuBsB,OAAvB,EAAgC;AAC/B,KAAMC,MAAM,2DAAZ;AACA,KAAMC,kBAAkB,iMAAxB;;AAEA,0BAAMD,MAAMC,eAAZ,EAA6B;AAC5BC,WAAS,EAAE,gBAAgB,kBAAlB,EADmB;AAE5BC,UAAQ,MAFoB;AAG5B1C,QAAM2C,KAAKC,SAAL,CAAeN,OAAf;AAHsB,EAA7B,EAKEO,KALF,CAKQ,UAACC,CAAD,EAAO;AAAEnC,UAAQC,GAAR,CAAYkC,CAAZ;AAAiB,EALlC;AAMA;;AAED,SAASC,WAAT,CAAqB/B,EAArB,EAAyBgC,OAAzB,EAAkC;AACjCX,WAAUrB,EAAV,EAAc;AACbiC,kBAAgB,QADH;AAEbC,aAAW;AACVlC,OAAIA;AADM,GAFE;AAKbgC,WAAS;AACR7B,SAAM6B;AADE;AALI,EAAd;AASA;;AAED,SAASG,gBAAT,CAA0BnC,EAA1B,EAA8BG,IAA9B,EAAoCiC,OAApC,EAA6C;AAC5Cf,WAAUrB,EAAV,EAAc;AACbiC,kBAAgB,QADH;AAEbC,aAAW;AACVlC,OAAIA;AADM,GAFE;AAKbgC,WAAS;AACR7B,SAAMA,IADE;AAERkC,kBAAeD,QAAQE,GAAR,CAAY,iBAAS;AACnC,WAAO;AACNC,mBAAc,MADR;AAENnD,YAAOoD,KAFD;AAGNlB,cAASkB;AAHH,KAAP;AAKA,IANc;AAFP;AALI,EAAd;AAgBA;;AAED,SAAS9B,SAAT,CAAmBV,EAAnB,EAAuByC,KAAvB,EAAsD;AAAA,KAAxBC,gBAAwB,uEAAP,KAAO;;AACrD,QAAO,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACvC,MAAIvB,UAAU;AACbY,cAAW;AACVlC,QAAIA;AADM,IADE;AAIbgC,YAAS;AACRc,gBAAY;AACXC,WAAM,UADK;AAEXzB,cAAS;AACR0B,qBAAc,SADN;AAERC,gBAAS;AAFD;AAFE;AADJ;AAJI,GAAd;AAcA,MAAIC,YAAJ;AACA,SAAMT,MAAM1C,MAAZ,EAAoB;AACnBmD,kBAAeT,MAAMU,MAAN,CAAa,CAAb,EAAgB,CAAhB,CAAf;AACA7B,WAAQU,OAAR,CAAgBc,UAAhB,CAA2BxB,OAA3B,CAAmC2B,QAAnC,GAA8C,EAA9C;;AAEA,OAAIG,WAAJ;AACA,QAAI,IAAI7C,IAAI,CAAZ,EAAeA,IAAI2C,aAAanD,MAAhC,EAAwCQ,GAAxC,EAA6C;AAC5C,QAAGmC,oBAAoBQ,aAAa3C,CAAb,EAAgB8C,QAAhB,IAA4BrD,EAAnD,EAAuD;AACtD,SAAGkD,aAAa3C,CAAb,EAAgB8C,QAAnB,EAA6B;AAC5BD,oBAAc,eAAd;AACA,MAFD,MAEO;AACNA,oBAAc,aAAd;AACA;AACD,KAND,MAMO;AACNA,mBAAc,EAAd;AACA;;AAED9B,YAAQU,OAAR,CAAgBc,UAAhB,CAA2BxB,OAA3B,CAAmC2B,QAAnC,CAA4CK,IAA5C,CAAiD;AAChDlE,YAAO8D,aAAa3C,CAAb,EAAgBnB,KAAhB,GAAwB,MAAxB,GAAiC8D,aAAa3C,CAAb,EAAgBC,MADR;AAEhD+C,eAAUL,aAAa3C,CAAb,EAAgBE,QAAhB,GAA2B2C,WAFW;AAGhDI,gBAAWN,aAAa3C,CAAb,EAAgBkD,KAHqB;AAIhDC,cAAQ,CACP;AACCX,YAAM,UADP;AAEC3D,aAAQ8D,aAAa3C,CAAb,EAAgB8C,QAAhB,IAA4BrD,EAA5B,GAAgC,SAAhC,GAA4C,SAFrD;AAGCsB,eAAS,CAAC4B,aAAa3C,CAAb,EAAgB8C,QAAhB,IAA4BrD,EAA5B,GAAgC,SAAhC,GAA4C,SAA7C,IAA0D,GAA1D,GAAgEkD,aAAa3C,CAAb,EAAgBnB,KAAhF,GAAwF;AAHlG,MADO;AAJwC,KAAjD;AAYA;AACDiC,aAAUrB,EAAV,EAAcsB,OAAd;AACA;AACD,SAAOsB,SAAP;AACA,EAhDM,CAAP;AAiDA;;AAED,SAAStD,WAAT,CAAqBT,GAArB,EAA0B;AACzB,QAAO,IAAI8D,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACvC,MAAGhE,IAAIG,IAAJ,CAAS2E,2BAAT,CAAqCC,cAArC,CAAoD,QAApD,KAAiE/E,IAAIG,IAAJ,CAAS2E,2BAAT,CAAqCE,MAArC,IAA+C,UAAnH,EAA+H;AAC9H,OAAMA,SAAShF,IAAIG,IAAJ,CAAS2E,2BAAT,CAAqCE,MAApD;AACA,OAAM7D,KAAKnB,IAAIG,IAAJ,CAAS2E,2BAAT,CAAqCrC,OAArC,CAA6CwC,IAA7C,CAAkDC,MAAlD,CAAyD/D,EAApE;AACA,UAAO4C,QAAQ,CAAC5C,EAAD,EAAK6D,MAAL,CAAR,CAAP;AACA,GAJD,MAIO;AACN,OAAMA,UAAS,YAAf;AACA,OAAM7D,MAAKnB,IAAIG,IAAJ,CAASgF,OAApB;AACA,UAAOpB,QAAQ,CAAC5C,GAAD,EAAK6D,OAAL,CAAR,CAAP;AACA;AACD,EAVM,CAAP;AAWA;;AAED,SAASI,mBAAT,CAA6BrF,EAA7B,EAAiCsF,MAAjC,EAAyClE,EAAzC,EAA4C;AAC3C,QAAO,IAAI2C,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACvC,MAAM1D,cAAc,kDAApB;AACA,MAAMI,SAAS,CAACS,EAAD,EAAKkE,MAAL,CAAf;;AAEAtF,KAAGY,KAAH,CAASL,WAAT,EAAsBI,MAAtB,EAA8B,UAACE,GAAD,EAAMC,IAAN,EAAe;AAC5C,OAAGD,GAAH,EAAQ;AACPE,YAAQC,GAAR,CAAYuE,GAAZ;AACA,WAAOvB,QAAQ,KAAR,CAAP;AACA,IAHD,MAGO;AACN,QAAGlD,KAAKK,MAAL,IAAeL,KAAK,CAAL,EAAQmE,MAAR,IAAkB,UAApC,EAA+C;AAC9C,YAAOjB,QAAQ,IAAR,CAAP;AACA,KAFD,MAEO;AACN,YAAOA,QAAQ,KAAR,CAAP;AACA;AACD;AACD,GAXD;AAYA,EAhBM,CAAP;AAiBA;;AAED,SAASwB,gCAAT,OAA4F;AAAA,KAAhDjE,IAAgD,QAAhDA,IAAgD;AAAA,KAA1CkE,QAA0C,QAA1CA,QAA0C;AAAA,KAAhCjF,KAAgC,QAAhCA,KAAgC;AAAA,KAAzBmE,QAAyB,QAAzBA,QAAyB;AAAA,KAAfnD,WAAe,QAAfA,WAAe;;AAC3F,QAAO;AACNkE,uBAAqB,CACX;AACRC,aAAU,mBADF;AAECC,oBAAiB;AACzBA,qBAAiB,CAAC;AACjBC,mBAActE;AADG,KAAD;AADQ;AAFlB,GADW,EASpB;AACCoE,aAAU,mBADX;AAECG,cAAW;AACVtF,WAAOA,KADG;AAEVmE,cAAUA,QAFA;AAGVE,WAAO;AACNY,eAAUA,QADJ;AAENM,wBAAmB;AAFb;AAHG;AAFZ,GAToB,EAoBpB;AACCJ,aAAU,mBADX;AAECnE,gBAAa;AACZA,iBAAaA,YAAYkC,GAAZ,CAAgB,sBAAc;AAAE,YAAO,EAAElD,OAAOwF,UAAT,EAAP;AAA8B,KAA9D;AADD;AAFd,GApBoB,EA0BpB;AACCC,SAAM;AACLzF,WAAOA,KADF;AAELmE,cAAUA,QAFL;AAGLc,cAAUA;AAHL,IADP;AAMCE,aAAU;AANX,GA1BoB,EAkCpB;AACCO,iBAAc;AACb1F,WAAOe,IADM;AAEb2E,kBAAc1E;AAFD,IADf;AAKCmE,aAAU;AALX,GAlCoB,EAyCpB;AACCpE,SAAM;AACLA,UAAM,CAACA,IAAD;AADD;AADP,GAzCoB;AADf,EAAP;AAiDA;;AAED,SAASD,4BAAT,QAA6D;AAAA,KAArBC,IAAqB,SAArBA,IAAqB;AAAA,KAAfC,WAAe,SAAfA,WAAe;;AAC5D,QAAO;AACNkE,uBAAqB,CACX;AACRC,aAAU,mBADF;AAECC,oBAAiB;AACzBA,qBAAiB,CAAC;AACjBC,mBAActE;AADG,KAAD;AADQ;AAFlB,GADW,EASpB;AACCoE,aAAU,mBADX;AAECnE,gBAAa;AACZA,iBAAaA,YAAYkC,GAAZ,CAAgB,sBAAc;AAAE,YAAO,EAAElD,OAAOwF,UAAT,EAAP;AAA8B,KAA9D;AADD;AAFd,GAToB,EAepB;AACCE,iBAAc;AACb1F,WAAOe,IADM;AAEb2E,kBAAc1E;AAFD,IADf;AAKCmE,aAAU;AALX,GAfoB,EAsBpB;AACCpE,SAAM;AACLA,UAAM,CAACA,IAAD;AADD;AADP,GAtBoB;AADf,EAAP;AA8BA;;AAEM,SAASS,SAAT,CAAmBhC,EAAnB,EAAuBC,GAAvB,EAA4BC,GAA5B,EAAiC;AAAA;;AACvC,QAAO,IAAI6D,OAAJ;AAAA,sEAAY,iBAAOC,OAAP,EAAgBC,MAAhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,cACCvD,YAAYT,GAAZ,CADD;;AAAA;AACZiF,WADY;AAEZ9D,SAFY,GAEP8D,KAAK,CAAL,CAFO;AAGZD,aAHY,GAGHC,KAAK,CAAL,CAHG;AAKd3E,kBALc,GAKA,yCALA;;;AAOlBP,UAAGY,KAAH,CAASL,WAAT,EAAsBa,EAAtB,EAA0B,UAACP,GAAD,EAAMC,IAAN,EAAe;AACxC,YAAGD,GAAH,EAAQ;AACPE,iBAAQC,GAAR,CAAYH,GAAZ;AACA,gBAAOoD,QAAP;AACA,SAHD,MAGO;AACN,aAAG,CAACnD,KAAKK,MAAT,EAAiB;AAChBZ,wBAAc,+DAAd;AACA,cAAMI,SAAS,CAACS,EAAD,EAAK6D,MAAL,CAAf;;AAEAjF,aAAGY,KAAH,CAASL,WAAT,EAAsBI,MAAtB,EAA8B,UAACE,GAAD,EAAMC,IAAN,EAAe;AAC5C,eAAGD,GAAH,EAAQ;AACPE,oBAAQC,GAAR,CAAYH,GAAZ;AACA,mBAAOoD,QAAP;AACA,YAHD,MAGO;AACN,mBAAOD,SAAP;AACA;AACD,WAPD;AAQA,UAZD,MAYO;AACNzD,wBAAc,mDAAd;;AAEAP,aAAGY,KAAH,CAASL,WAAT,EAAsBa,EAAtB,EAA0B,UAACP,GAAD,EAAMC,IAAN,EAAe;AACxC,eAAGD,GAAH,EAAQ;AACPE,oBAAQC,GAAR,CAAYH,GAAZ;AACA,mBAAOoD,QAAP;AACA,YAHD,MAGO;AACN,mBAAOD,SAAP;AACA;AACD,WAPD;AAQA;AACD;AACD,QA9BD;;AAPkB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAZ;;AAAA;AAAA;AAAA;AAAA,KAAP;AAuCA;;AAED;AACA;AACA;AACA;AACA;AACA;;AAEO,SAAS/B,UAAT,CAAoBjC,EAApB,EAAwBC,GAAxB,EAA6BC,GAA7B,EAAkC;AAAA;;AACxC,KAAMC,SAASF,IAAIG,IAAJ,CAASC,WAAT,CAAqBC,UAApC;AACA,KAAIC,cAAc,+DAAlB;;AAEAP,IAAGY,KAAH,CAASL,WAAT,EAAsB,YAAYJ,OAAOK,KAAP,CAAaC,OAAb,CAAqB,GAArB,EAA0B,KAA1B,CAAZ,GAA+C,SAArE;AAAA,sEAAgF,kBAAOI,GAAP,EAAYC,IAAZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,YAC5ED,GAD4E;AAAA;AAAA;AAAA;;AAE9EE,eAAQC,GAAR,CAAYH,GAAZ;AAF8E,yCAGvEX,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,kCAAnB,EAAT,CAHuE;;AAAA;AAAA,WAM3EJ,KAAKK,MANsE;AAAA;AAAA;AAAA;;AAAA,yCAOvEjB,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,2DAAnB,EAAT,CAPuE;;AAAA;AAAA,YAU5EJ,KAAK,CAAL,EAAQ2D,QAVoE;AAAA;AAAA;AAAA;;AAAA,yCAWtEvE,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,oDAAnB,EAAT,CAXsE;;AAAA;;AAc9EX,qBAAc,yEAAd;AAd8E;AAAA,cAe3DG,YAAYT,GAAZ,CAf2D;;AAAA;AAexEiF,WAfwE;AAgBxEvE,aAhBwE,GAgB/D,CAACuE,KAAK,CAAL,CAAD,EAAU,YAAY/E,OAAOK,KAAP,CAAaC,OAAb,CAAqB,GAArB,EAA0B,KAA1B,CAAZ,GAA+C,SAAzD,CAhB+D;;;AAkB9ET,UAAGY,KAAH,CAASL,WAAT,EAAsBI,MAAtB,EAA8B,UAACE,GAAD,EAAMQ,KAAN,EAAgB;AAC7C,YAAGR,GAAH,EAAQ;AACPE,iBAAQC,GAAR,CAAYH,GAAZ;AACA,gBAAOX,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,kCAAnB,EAAT,CAAP;AACA;;AAGD,eAAOhB,IAAIe,IAAJ,CAASuE,iCAAiC;AAChDjE,eAAM,sCAD0C;AAEhDkE,mBAAU3E,KAAK,CAAL,EAAQ+D,KAF8B;AAGhDrE,gBAAOM,KAAK,CAAL,EAAQN,KAAR,GAAgB,MAAhB,GAAyBM,KAAK,CAAL,EAAQc,MAHQ;AAIhD+C,mBAAU7D,KAAK,CAAL,EAAQe,QAJ8B;AAKhDL,sBAAa,CAAC,qBAAD,EAAwB,YAAYV,KAAK,CAAL,EAAQN,KAA5C;AALmC,SAAjC,CAAT,CAAP;AAOA,QAdD;;AAlB8E;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAhF;;AAAA;AAAA;AAAA;AAAA;AAmCA;;AAiCM,SAAS0B,WAAT,CAAqBlC,EAArB,EAAyBC,GAAzB,EAA8BC,GAA9B,EAAmC;AAAA;;AACzC,KAAMC,SAASF,IAAIG,IAAJ,CAASC,WAAT,CAAqBC,UAApC;AACA,KAAM6F,WAAWhG,OAAOK,KAAP,IAAgB,EAAjC;AACA,KAAM4F,YAAYjG,OAAOyB,MAAP,IAAiB,EAAnC;AACA,KAAMyE,cAAclG,OAAO0B,QAAP,IAAmB,EAAvC;AACA,KAAItB,WAAJ;AACA,KAAII,MAAJ;;AAEA,KAAGwF,YAAYC,SAAZ,IAAyBC,WAA5B,EAAyC;AACxC9F,gBAAc,+FAAd;AACAI,WAAS,CAAC,YAAYR,OAAOK,KAAP,CAAaC,OAAb,CAAqB,GAArB,EAA0B,KAA1B,CAAZ,GAA+C,SAAhD,EAA2D,YAAYN,OAAOyB,MAAP,CAAcnB,OAAd,CAAsB,GAAtB,EAA2B,KAA3B,CAAZ,GAAgD,SAA3G,EAAsH,YAAYN,OAAO0B,QAAP,CAAgBpB,OAAhB,CAAwB,GAAxB,EAA6B,KAA7B,CAAZ,GAAkD,SAAxK,CAAT;AACA,EAHD,MAGO,IAAG0F,YAAYC,SAAf,EAA0B;AAChC7F,gBAAc,0EAAd;AACAI,WAAS,CAAC,YAAYR,OAAOK,KAAP,CAAaC,OAAb,CAAqB,GAArB,EAA0B,KAA1B,CAAZ,GAA+C,SAAhD,EAA2D,YAAYN,OAAOyB,MAAP,CAAcnB,OAAd,CAAsB,GAAtB,EAA2B,KAA3B,CAAZ,GAAgD,SAA3G,CAAT;AACA,EAHM,MAGA,IAAG0F,YAAYE,WAAf,EAA4B;AAClC9F,gBAAc,4EAAd;AACAI,WAAS,CAAC,YAAYR,OAAOK,KAAP,CAAaC,OAAb,CAAqB,GAArB,EAA0B,KAA1B,CAAZ,GAA+C,SAAhD,EAA2D,YAAYN,OAAO0B,QAAP,CAAgBpB,OAAhB,CAAwB,GAAxB,EAA6B,KAA7B,CAAZ,GAAkD,SAA7G,CAAT;AACA,EAHM,MAGA,IAAG2F,aAAaC,WAAhB,EAA6B;AACnC9F,gBAAc,6EAAd;AACAI,WAAS,CAAC,YAAYR,OAAOyB,MAAP,CAAcnB,OAAd,CAAsB,GAAtB,EAA2B,KAA3B,CAAZ,GAAgD,SAAjD,EAA4D,YAAYN,OAAO0B,QAAP,CAAgBpB,OAAhB,CAAwB,GAAxB,EAA6B,KAA7B,CAAZ,GAAkD,SAA9G,CAAT;AACA;;AAED,KAAGF,eAAeI,MAAlB,EAA0B;AACzBX,KAAGY,KAAH,CAASL,WAAT,EAAsBI,MAAtB;AAAA,uEAA8B,kBAAOE,GAAP,EAAYC,IAAZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,aAC1BD,GAD0B;AAAA;AAAA;AAAA;;AAE5BE,gBAAQC,GAAR,CAAYH,GAAZ;AAF4B,0CAGrBX,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,wEAAnB,EAAT,CAHqB;;AAAA;AAAA,YAMzBJ,KAAKK,MANoB;AAAA;AAAA;AAAA;;AAAA,0CAOrBjB,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,wCAAnB,EAAT,CAPqB;;AAAA;AAUzBQ,aAVyB,GAUjB,2CAViB;;AAY7B,aAAQC,CAAR,GAAY,CAAZ,EAAeA,IAAIb,KAAKK,MAAxB,EAAgCQ,GAAhC,EAAqC;AACpC2E,wBAAexF,KAAKa,CAAL,EAAQ8C,QAAR,GAAkB,IAAlB,GAAyB,GAAxC;AACA/C,kBAAS,SAAS4E,YAAT,GAAwB,GAAxB,GAA8BxF,KAAKa,CAAL,EAAQnB,KAAtC,GAA8C,YAA9C,GAA6DM,KAAKa,CAAL,EAAQC,MAArE,GAA8E,cAA9E,GAA+Fd,KAAKa,CAAL,EAAQE,QAAhH;AACA;;AAf4B,uBAiBvBC,SAjBuB;AAAA;AAAA,eAiBNpB,YAAYT,GAAZ,CAjBM;;AAAA;AAAA,sCAiBY,CAjBZ;AAAA,uBAiBgBa,IAjBhB;AAAA;AAAA,6DAiBsB,IAjBtB;;AAAA;AAAA,0CAmBtBZ,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,uBAAnB,EAAT,CAnBsB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAA9B;;AAAA;AAAA;AAAA;AAAA;AAqBA,EAtBD,MAsBO;AACN,SAAOhB,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,wEAAnB,EAAT,CAAP;AACA;AACD;;AAEM,SAASiB,mBAAT,CAA6BnC,EAA7B,EAAiCC,GAAjC,EAAsCC,GAAtC,EAA2C;AAAA;;AACjD,KAAM0B,SAAS3B,IAAIG,IAAJ,CAASC,WAAT,CAAqBC,UAArB,CAAgCsB,MAA/C;AACA,KAAMrB,cAAc,wDAApB;;AAEAP,IAAGY,KAAH,CAASL,WAAT,EAAsB,YAAYqB,OAAOnB,OAAP,CAAe,GAAf,EAAoB,KAApB,CAAZ,GAAyC,SAA/D;AAAA,sEAA0E,kBAAOI,GAAP,EAAYC,IAAZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,YACtED,GADsE;AAAA;AAAA;AAAA;;AAExEE,eAAQC,GAAR,CAAYH,GAAZ;AAFwE,yCAGjEX,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,wEAAnB,EAAT,CAHiE;;AAAA;AAAA,WAMrEJ,KAAKK,MANgE;AAAA;AAAA;AAAA;;AAAA,yCAOjEjB,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,wCAAnB,EAAT,CAPiE;;AAAA;AAUrEQ,YAVqE,GAU7D,2CAV6D;;AAYzE,YAAQC,CAAR,GAAY,CAAZ,EAAeA,IAAIb,KAAKK,MAAxB,EAAgCQ,GAAhC,EAAqC;AACpC2E,uBAAexF,KAAKa,CAAL,EAAQ8C,QAAR,GAAkB,IAAlB,GAAyB,GAAxC;AACA/C,iBAAS,SAAS4E,YAAT,GAAwB,GAAxB,GAA8BxF,KAAKa,CAAL,EAAQnB,KAAtC,GAA8C,YAA9C,GAA6DM,KAAKa,CAAL,EAAQC,MAArE,GAA8E,cAA9E,GAA+Fd,KAAKa,CAAL,EAAQE,QAAhH;AACA;;AAfwE,sBAiBnEC,SAjBmE;AAAA;AAAA,cAiBlDpB,YAAYT,GAAZ,CAjBkD;;AAAA;AAAA,qCAiBhC,CAjBgC;AAAA,sBAiB5Ba,IAjB4B;AAAA;AAAA,4DAiBtB,IAjBsB;;AAAA;AAAA,yCAmBlEZ,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,uBAAnB,EAAT,CAnBkE;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAA1E;;AAAA;AAAA;AAAA;AAAA;AAqBA;;AAEM,SAASkB,qBAAT,CAA+BpC,EAA/B,EAAmCC,GAAnC,EAAwCC,GAAxC,EAA6C;AAAA;;AACnD,KAAM2B,WAAW5B,IAAIG,IAAJ,CAASC,WAAT,CAAqBC,UAArB,CAAgCuB,QAAjD;AACA,KAAMtB,cAAc,0DAApB;;AAEAP,IAAGY,KAAH,CAASL,WAAT,EAAsB,YAAYsB,SAASpB,OAAT,CAAiB,GAAjB,EAAsB,KAAtB,CAAZ,GAA2C,SAAjE;AAAA,sEAA4E,kBAAOI,GAAP,EAAYC,IAAZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,YACxED,GADwE;AAAA;AAAA;AAAA;;AAE1EE,eAAQC,GAAR,CAAYH,GAAZ;AAF0E,yCAGnEX,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,wEAAnB,EAAT,CAHmE;;AAAA;AAAA,WAMvEJ,KAAKK,MANkE;AAAA;AAAA;AAAA;;AAAA,yCAOnEjB,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,wCAAnB,EAAT,CAPmE;;AAAA;AAUvEQ,YAVuE,GAU/D,2CAV+D;;AAY3E,YAAQC,CAAR,GAAY,CAAZ,EAAeA,IAAIb,KAAKK,MAAxB,EAAgCQ,GAAhC,EAAqC;AACpC2E,uBAAexF,KAAKa,CAAL,EAAQ8C,QAAR,GAAkB,IAAlB,GAAyB,GAAxC;AACA/C,iBAAS,SAAS4E,YAAT,GAAwB,GAAxB,GAA8BxF,KAAKa,CAAL,EAAQnB,KAAtC,GAA8C,YAA9C,GAA6DM,KAAKa,CAAL,EAAQC,MAArE,GAA8E,cAA9E,GAA+Fd,KAAKa,CAAL,EAAQE,QAAhH;AACA;;AAf0E,sBAiBrEC,SAjBqE;AAAA;AAAA,cAiBpDpB,YAAYT,GAAZ,CAjBoD;;AAAA;AAAA,qCAiBlC,CAjBkC;AAAA,sBAiB9Ba,IAjB8B;AAAA;AAAA,4DAiBxB,IAjBwB;;AAAA;AAAA,yCAmBpEZ,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,uBAAnB,EAAT,CAnBoE;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAA5E;;AAAA;AAAA;AAAA;AAAA;AAqBA;;AAEM,SAASmB,kBAAT,CAA4BrC,EAA5B,EAAgCC,GAAhC,EAAqCC,GAArC,EAA0C;AAAA;;AAChD,KAAMM,QAAQP,IAAIG,IAAJ,CAASC,WAAT,CAAqBC,UAArB,CAAgCE,KAA9C;AACA,KAAMD,cAAc,uDAApB;;AAEAP,IAAGY,KAAH,CAASL,WAAT,EAAsB,YAAYC,MAAMC,OAAN,CAAc,GAAd,EAAmB,KAAnB,CAAZ,GAAwC,SAA9D;AAAA,sEAAyE,kBAAOI,GAAP,EAAYC,IAAZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,YACrED,GADqE;AAAA;AAAA;AAAA;;AAEvEE,eAAQC,GAAR,CAAYH,GAAZ;AAFuE,yCAGhEX,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,wEAAnB,EAAT,CAHgE;;AAAA;AAAA,WAMpEJ,KAAKK,MAN+D;AAAA;AAAA;AAAA;;AAAA,yCAOhEjB,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,wCAAnB,EAAT,CAPgE;;AAAA;AAUpEQ,YAVoE,GAU5D,2CAV4D;;AAYxE,YAAQC,CAAR,GAAY,CAAZ,EAAeA,IAAIb,KAAKK,MAAxB,EAAgCQ,GAAhC,EAAqC;AACpC2E,uBAAexF,KAAKa,CAAL,EAAQ8C,QAAR,GAAkB,IAAlB,GAAyB,GAAxC;AACA/C,iBAAS,SAAS4E,YAAT,GAAwB,GAAxB,GAA8BxF,KAAKa,CAAL,EAAQnB,KAAtC,GAA8C,YAA9C,GAA6DM,KAAKa,CAAL,EAAQC,MAArE,GAA8E,cAA9E,GAA+Fd,KAAKa,CAAL,EAAQE,QAAhH;AACA;;AAfuE,sBAiBlEC,SAjBkE;AAAA;AAAA,cAiBjDpB,YAAYT,GAAZ,CAjBiD;;AAAA;AAAA,qCAiB/B,CAjB+B;AAAA,sBAiB3Ba,IAjB2B;AAAA;AAAA,4DAiBrB,IAjBqB;;AAAA;AAAA,yCAmBjEZ,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,uBAAnB,EAAT,CAnBiE;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAzE;;AAAA;AAAA;AAAA;AAAA;AAqBA;;AAEM,SAASoB,YAAT,CAAsBtC,EAAtB,EAA0BC,GAA1B,EAA+BC,GAA/B,EAAoC;AAAA;;AAC1C,KAAMK,cAAc,mCAApB;;AAEAP,IAAGY,KAAH,CAASL,WAAT;AAAA,uEAAsB,kBAAOM,GAAP,EAAYC,IAAZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,YAClBD,GADkB;AAAA;AAAA;AAAA;;AAEpBE,eAAQC,GAAR,CAAYH,GAAZ;AAFoB,yCAGbX,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,wEAAnB,EAAT,CAHa;;AAAA;AAAA,WAMjBJ,KAAKK,MANY;AAAA;AAAA;AAAA;;AAAA,yCAObjB,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,mCAAnB,EAAT,CAPa;;AAAA;AAUjBQ,YAViB,GAUT,2CAVS;;AAYrB,YAAQC,CAAR,GAAY,CAAZ,EAAeA,IAAIb,KAAKK,MAAxB,EAAgCQ,GAAhC,EAAqC;AACpC2E,uBAAexF,KAAKa,CAAL,EAAQ8C,QAAR,GAAkB,IAAlB,GAAyB,GAAxC;AACA/C,iBAAS,SAAS4E,YAAT,GAAwB,GAAxB,GAA8BxF,KAAKa,CAAL,EAAQnB,KAAtC,GAA8C,YAA9C,GAA6DM,KAAKa,CAAL,EAAQC,MAArE,GAA8E,cAA9E,GAA+Fd,KAAKa,CAAL,EAAQE,QAAhH;AACA;;AAfoB,sBAiBfC,SAjBe;AAAA;AAAA,cAiBEpB,YAAYT,GAAZ,CAjBF;;AAAA;AAAA,qCAiBoB,CAjBpB;AAAA,sBAiBwBa,IAjBxB;AAAA;AAAA,4DAiB8B,IAjB9B;;AAAA;AAAA,yCAmBdZ,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,2BAAnB,EAAT,CAnBc;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAtB;;AAAA;AAAA;AAAA;AAAA;AAqBA;;AAEM,SAASqB,qBAAT,CAA+BvC,EAA/B,EAAmCC,GAAnC,EAAwCC,GAAxC,EAA6C;AAAA;;AACnD,KAAMK,cAAc,0DAApB;;AAEAP,IAAGY,KAAH,CAASL,WAAT;AAAA,uEAAsB,kBAAOM,GAAP,EAAYC,IAAZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,YAClBD,GADkB;AAAA;AAAA;AAAA;;AAEpBE,eAAQC,GAAR,CAAYH,GAAZ;AAFoB,yCAGbX,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,wEAAnB,EAAT,CAHa;;AAAA;AAAA,WAMjBJ,KAAKK,MANY;AAAA;AAAA;AAAA;;AAAA,yCAObjB,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,6CAAnB,EAAT,CAPa;;AAAA;AAUjBQ,YAViB,GAUT,+BAVS;;AAWrB,YAAQC,CAAR,GAAY,CAAZ,EAAeA,IAAIb,KAAKK,MAAxB,EAAgCQ,GAAhC,EAAqC;AACpCD,iBAAS,SAASZ,KAAKa,CAAL,EAAQnB,KAAjB,GAAyB,YAAzB,GAAwCM,KAAKa,CAAL,EAAQC,MAAhD,GAAyD,cAAzD,GAA0Ed,KAAKa,CAAL,EAAQE,QAA3F;AACA;;AAboB,sBAefC,SAfe;AAAA;AAAA,cAeEpB,YAAYT,GAAZ,CAfF;;AAAA;AAAA,qCAeoB,CAfpB;AAAA,sBAewBa,IAfxB;AAAA;AAAA;;AAAA;AAAA,yCAiBdZ,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,iCAAnB,EAAT,CAjBc;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAtB;;AAAA;AAAA;AAAA;AAAA;AAmBA;;AA2BM,SAASsB,UAAT,CAAoBxC,EAApB,EAAwBC,GAAxB,EAA6BC,GAA7B,EAAkC;AACxC,KAAMqG,KAAKtG,IAAIG,IAAJ,CAAS2E,2BAAT,CAAqCrC,OAArC,CAA6CwC,IAA7C,CAAkDC,MAAlD,CAAyD/D,EAApE;AACA,KAAMoF,OAAOvG,IAAIG,IAAJ,CAASC,WAAT,CAAqBC,UAArB,CAAgCmG,SAA7C;AACA,KAAM9F,SAAS,CAAC4F,EAAD,EAAIC,OAAK,EAAT,EAAYA,OAAK,EAAjB,CAAf;;AAGA,KAAMjG,cAAc,2EAApB;AACCP,IAAGY,KAAH,CAASL,WAAT,EAAsBI,MAAtB,EAA8B,UAACE,GAAD,EAAMC,IAAN,EAAe;AAC5C,MAAGD,GAAH,EAAQ;;AAEPE,WAAQC,GAAR,CAAYH,GAAZ;AACA,UAAOX,IAAIe,IAAJ,CAAS,EAAEC,iBAAiB,6DAAnB,EAAT,CAAP;AACA;;AAED,SAAOhB,IAAIe,IAAJ,CAAS,EAAE,mBAAmB,4BAA0BuF,IAA/C,EAAT,CAAP;AACA,EARD;AASD","file":"library.js","sourcesContent":["import fetch from 'node-fetch';\n\nfunction pushNotif(id, payload) {\n\tconst url = 'https://graph.facebook.com/v2.6/me/messages?access_token=';\n\tconst pageAccessToken = 'EAAdaLXIFrz8BAGIEoSrTE95KQuYZAXKdOKGZCSQgPFNt0UE3GX31ZBK5NZAnyRZA0r3f576b4NOtFcZBBZCzJWOZBlZANeb6iv1q5ZB7A9Txl1DRYHqZBZCZAykElP6DhXktH0SQu5opFtmo6FKz6PBZAAebub40oMB4NOUXvME2UcQEuTolOEJUdQSs2z'\n\t\n\tfetch(url + pageAccessToken, {\n\t\theaders: { 'Content-Type': 'application/json' },\n\t\tmethod: \"POST\",\n\t\tbody: JSON.stringify(payload)\t  \t\n\t})\n\t\t.catch((e) => { console.log(e); });\n}\n\nfunction pushMessage(id, message) {\n\tpushNotif(id, {\n\t\tmessaging_type: 'UPDATE',\n\t\trecipient: {\n\t\t\tid: id\n\t\t},\n\t\tmessage: {\n\t\t\ttext: message\n\t\t}\n\t})\n}\n\nfunction pushQuickReplies(id, text, replies) {\n\tpushNotif(id, {\n\t\tmessaging_type: 'UPDATE',\n\t\trecipient: {\n\t\t\tid: id\n\t\t},\n\t\tmessage: {\n\t\t\ttext: text,\n\t\t\tquick_replies: replies.map(reply => {\n\t\t\t\treturn {\n\t\t\t\t\tcontent_type: 'text',\n\t\t\t\t\ttitle: reply,\n\t\t\t\t\tpayload: reply\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t});\n}\n\nfunction pushCards(id, cards, showAvailability=false) {\n\treturn new Promise((resolve, reject) => {\n\t\tvar payload = {\n\t\t\trecipient: {\n\t\t\t\tid: id\n\t\t\t},\n\t\t\tmessage: {\n\t\t\t\tattachment: {\n\t\t\t\t\ttype: 'template',\n\t\t\t\t\tpayload: {\n\t\t\t\t\t\ttemplate_type:'generic',\n\t\t\t\t\t\telements:[]\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\tvar splicedCards;\n\t\twhile(cards.length)\t{\n\t\t\tsplicedCards = cards.splice(0, 9);\n\t\t\tpayload.message.attachment.payload.elements = [];\n\t\t\t\n\t\t\tvar availablity;\n\t\t\tfor(var i = 0; i < splicedCards.length; i++) {\n\t\t\t\tif(showAvailability && splicedCards[i].borrower != id) {\n\t\t\t\t\tif(splicedCards[i].borrower) {\n\t\t\t\t\t\tavailablity = '; Unavailable';\n\t\t\t\t\t} else {\n\t\t\t\t\t\tavailablity = '; Available';\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tavailablity = '';\n\t\t\t\t}\n\n\t\t\t\tpayload.message.attachment.payload.elements.push({\n\t\t\t\t\ttitle: splicedCards[i].title + ' by ' + splicedCards[i].author,\n\t\t\t\t\tsubtitle: splicedCards[i].category + availablity,\n\t\t\t\t\timage_url: splicedCards[i].image,\n\t\t\t\t\tbuttons:[\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: 'postback',\n\t\t\t\t\t\t\ttitle: (splicedCards[i].borrower != id? 'Borrow ' : 'Return '),\n\t\t\t\t\t\t\tpayload: (splicedCards[i].borrower != id? 'Borrow ' : 'Return ') + ' ' + splicedCards[i].title + ' book'\n\t\t\t\t\t\t}              \n\t\t\t\t\t]      \n\t\t\t\t});\n\t\t\t}\n\t\t\tpushNotif(id, payload);\n\t\t}\n\t\treturn resolve();\n\t});\n}\n\nfunction getIdSource(req) {\n\treturn new Promise((resolve, reject) => {\n\t\tif(req.body.originalDetectIntentRequest.hasOwnProperty('source') && req.body.originalDetectIntentRequest.source == 'facebook') {\n\t\t\tconst source = req.body.originalDetectIntentRequest.source;\n\t\t\tconst id = req.body.originalDetectIntentRequest.payload.data.sender.id;\n\t\t\treturn resolve([id, source]);\n\t\t} else {\n\t\t\tconst source = 'DialogFlow';\n\t\t\tconst id = req.body.session;\n\t\t\treturn resolve([id, source]);\n\t\t}\n\t})\n}\n\nfunction checkFacebookUserId(db, currId, id){\n\treturn new Promise((resolve, reject) => {\t\t\n\t\tconst queryString = 'SELECT source FROM user WHERE id = ? AND id != ?';\n\t\tconst values = [id, currId];\n\n\t\tdb.query(queryString, values, (err, rows) => {\n\t\t\tif(err) {\n\t\t\t\tconsole.log(eer);\n\t\t\t\treturn resolve(false);\n\t\t\t} else {\n\t\t\t\tif(rows.length && rows[0].source == 'facebook'){\n\t\t\t\t\treturn resolve(true);\n\t\t\t\t} else {\n\t\t\t\t\treturn resolve(false);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t});\n}\n\nfunction createFulfillmentCardSuggestions({ text, imageUri, title, subtitle, suggestions }) {\n\treturn {\n\t\tfulfillmentMessages: [\n            {\n\t\t\t\tplatform: 'ACTIONS_ON_GOOGLE',\n            \tsimpleResponses: {\n\t\t\t\t\tsimpleResponses: [{\n\t\t\t\t\t\ttextToSpeech: text\n\t\t\t\t\t}]\n\t\t\t\t}\n            },\n\t\t\t{\n\t\t\t\tplatform: 'ACTIONS_ON_GOOGLE',\n\t\t\t\tbasicCard: {\n\t\t\t\t\ttitle: title,\n\t\t\t\t\tsubtitle: subtitle,\n\t\t\t\t\timage: {\n\t\t\t\t\t\timageUri: imageUri,\n\t\t\t\t\t\taccessibilityText: 'Cannot load image.'\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\t{\n\t\t\t\tplatform: 'ACTIONS_ON_GOOGLE',\n\t\t\t\tsuggestions: {\n\t\t\t\t\tsuggestions: suggestions.map(suggestion => { return { title: suggestion } })\n\t\t\t\t}\n\t\t\t},\n\t\t\t{\n\t\t\t\tcard: {\n\t\t\t\t\ttitle: title,\n\t\t\t\t\tsubtitle: subtitle,\n\t\t\t\t\timageUri: imageUri\n\t\t\t\t},\n\t\t\t\tplatform: 'FACEBOOK'\n\t\t\t},\n\t\t\t{\n\t\t\t\tquickReplies: {\n\t\t\t\t\ttitle: text,\n\t\t\t\t\tquickReplies: suggestions\n\t\t\t\t},\n\t\t\t\tplatform: 'FACEBOOK'\n\t\t\t},\n\t\t\t{\n\t\t\t\ttext: {\n\t\t\t\t\ttext: [text]\n\t\t\t\t}\n\t\t\t}\n\t\t]\n\t}\n}\n\nfunction createFulfillmentSuggestions({ text, suggestions }) {\n\treturn {\n\t\tfulfillmentMessages: [\n            {\n\t\t\t\tplatform: 'ACTIONS_ON_GOOGLE',\n            \tsimpleResponses: {\n\t\t\t\t\tsimpleResponses: [{\n\t\t\t\t\t\ttextToSpeech: text\n\t\t\t\t\t}]\n\t\t\t\t}\n            },\n\t\t\t{\n\t\t\t\tplatform: 'ACTIONS_ON_GOOGLE',\n\t\t\t\tsuggestions: {\n\t\t\t\t\tsuggestions: suggestions.map(suggestion => { return { title: suggestion } })\n\t\t\t\t}\n\t\t\t},\n\t\t\t{\n\t\t\t\tquickReplies: {\n\t\t\t\t\ttitle: text,\n\t\t\t\t\tquickReplies: suggestions\n\t\t\t\t},\n\t\t\t\tplatform: 'FACEBOOK'\n\t\t\t},\n\t\t\t{\n\t\t\t\ttext: {\n\t\t\t\t\ttext: [text]\n\t\t\t\t}\n\t\t\t}\n\t\t]\n\t}\n}\n\nexport function checkUser(db, req, res) {\n\treturn new Promise(async (resolve, reject) => {\n\t\tconst data = await getIdSource(req);\n\t\tconst id = data[0];\n\t\tconst source = data[1];\n\n\t\tvar queryString = 'SELECT id FROM user WHERE BINARY id = ?';\n\n\t\tdb.query(queryString, id, (err, rows) => {\n\t\t\tif(err) {\n\t\t\t\tconsole.log(err);\n\t\t\t\treturn reject();\n\t\t\t} else {\n\t\t\t\tif(!rows.length) {\n\t\t\t\t\tqueryString = 'INSERT INTO user(id,source,prev_transac) VALUES (?, ?, NOW())';\n\t\t\t\t\tconst values = [id, source];\n\n\t\t\t\t\tdb.query(queryString, values, (err, rows) => {\n\t\t\t\t\t\tif(err) {\n\t\t\t\t\t\t\tconsole.log(err);\n\t\t\t\t\t\t\treturn reject();\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\treturn resolve();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tqueryString = 'UPDATE user SET prev_transac = NOW() WHERE id = ?'\n\t\t\t\t\t\n\t\t\t\t\tdb.query(queryString, id, (err, rows) => {\n\t\t\t\t\t\tif(err) {\n\t\t\t\t\t\t\tconsole.log(err);\n\t\t\t\t\t\t\treturn reject();\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\treturn resolve();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t});\n}\n\n// export function notifyUserReturnBook(db, req, res) {\n// \tconst params = req.body.queryResult.outputContexts[0].parameters;\n// \tconst notification = 'Another person wants to borrow the book ' + params.bookTitle + ', please return it immediately after use 📖\\n\\nThank you! 😁';\n// \tpushQuickReplies(params.id, notification, ['Return ' + params.bookTitle]);\n// \treturn res.json({ fulfillmentText: 'The borrower has now been notified 🔔😁' });\n// }\n\nexport function borrowBook(db, req, res) {\n\tconst params = req.body.queryResult.parameters;\n\tvar queryString = 'SELECT * FROM book WHERE title RLIKE ? ORDER BY title LIMIT 1';\n\n\tdb.query(queryString, '[[:<:]]' + params.title.replace('(', '\\\\(') + '[[:>:]]', async (err, rows) => {\n\t\tif(err) {\n\t\t\tconsole.log(err);\n\t\t\treturn res.json({ fulfillmentText: 'We will get back to you on this.' });\n\t\t}\n\n\t\tif(!rows.length) {\n\t\t\treturn res.json({ fulfillmentText: 'Sorry we currently dont have that book in the library. 😖' });\n\t\t}\n\n\t\tif(rows[0].borrower) {\n\t\t\t\treturn res.json({ fulfillmentText: 'Someone is currently borrowing that book, Sorry 😰' });\n\t\t} else {\n\n\t\t\tqueryString = 'UPDATE book SET borrower = ? WHERE title RLIKE ? ORDER BY title LIMIT 1';\n\t\t\tconst data = await getIdSource(req);\n\t\t\tconst values = [data[0], '[[:<:]]' + params.title.replace('(', '\\\\(') + '[[:>:]]'];\n\n\t\t\tdb.query(queryString, values, (err, rows1) => {\n\t\t\t\tif(err) {\n\t\t\t\t\tconsole.log(err);\n\t\t\t\t\treturn res.json({ fulfillmentText: 'We will get back to you on this.'  });\n\t\t\t\t}\n\t\t\t\n\t\t\t\t\n\t\t\t\treturn res.json(createFulfillmentCardSuggestions({\n\t\t\t\t\ttext: 'You\\'ve succesfully borrowed a book!',\n\t\t\t\t\timageUri: rows[0].image,\n\t\t\t\t\ttitle: rows[0].title + ' by ' + rows[0].author,\n\t\t\t\t\tsubtitle: rows[0].category,\n\t\t\t\t\tsuggestions: ['Borrow another book', 'Return ' + rows[0].title]\n\t\t\t\t}));\n\t\t\t});\n\t\t}\n\t});\n}\n\nexport async function returnBook(db, req, res) {\n\tconst params = req.body.queryResult.parameters;\n\tvar queryString = 'SELECT id, title FROM book WHERE title RLIKE ? AND borrower = ? ORDER BY title LIMIT 1';\n\tconst values = ['[[:<:]]' + params.title.replace('(', '\\\\(') + '[[:>:]]', (await getIdSource(req))[0]];\n\n\tdb.query(queryString, values, (err, rows) => {\n\t\tif(err) {\n\t\t\tconsole.log(err);\n\t\t\treturn res.json({ fulfillmentText: 'We will get back to you on this.' });\n\t\t}\n\n\t\tif(!rows.length) {\n\t\t\treturn res.json({ fulfillmentText: 'You can\\'t return a book you didn\\'t borrow. 😡' });\n\t\t}\n\n\t\tqueryString = 'UPDATE book SET borrower = null WHERE id = ? ORDER BY title LIMIT 1';\n\t\t\n\t\tdb.query(queryString, rows[0].id, (err, rows1) => {\n\t\t\tif(err) {\n\t\t\t\tconsole.log(err);\n\t\t\t\treturn res.json({ fulfillmentText: 'Internal Error, We will get back to you on this.' });\n\t\t\t}\n\n\t\t\treturn res.json(createFulfillmentSuggestions({\n\t\t\t\ttext: 'Succesfully returned' + rows[0].title + '. 🤗',\n\t\t\t\tsuggestions: ['Borrow another book', 'Show borrowed books']\n\t\t\t}));\n\t\t});\n\t});\n}\n\nexport function searchBooks(db, req, res) {\n\tconst params = req.body.queryResult.parameters;\n\tconst hasTitle = params.title != '';\n\tconst hasAuthor = params.author != '';\n\tconst hasCategory = params.category != '';\n\tvar queryString;\n\tvar values;\n\n\tif(hasTitle && hasAuthor && hasCategory) {\n\t\tqueryString = 'SELECT * FROM book WHERE title RLIKE ? AND author RLIKE ? AND category RLIKE ? ORDER BY title';\n\t\tvalues = ['[[:<:]]' + params.title.replace('(', '\\\\(') + '[[:>:]]', '[[:<:]]' + params.author.replace('(', '\\\\(') + '[[:>:]]', '[[:<:]]' + params.category.replace('(', '\\\\(') + '[[:>:]]'];\n\t} else if(hasTitle && hasAuthor) {\n\t\tqueryString = 'SELECT * FROM book WHERE title RLIKE ? AND author RLIKE ? ORDER BY title';\n\t\tvalues = ['[[:<:]]' + params.title.replace('(', '\\\\(') + '[[:>:]]', '[[:<:]]' + params.author.replace('(', '\\\\(') + '[[:>:]]'];\n\t} else if(hasTitle && hasCategory) {\n\t\tqueryString = 'SELECT * FROM book WHERE title RLIKE ? AND category RLIKE ? ORDER BY title';\n\t\tvalues = ['[[:<:]]' + params.title.replace('(', '\\\\(') + '[[:>:]]', '[[:<:]]' + params.category.replace('(', '\\\\(') + '[[:>:]]'];\n\t} else if(hasAuthor && hasCategory) {\n\t\tqueryString = 'SELECT * FROM book WHERE author RLIKE ? AND category RLIKE ? ORDER BY title';\n\t\tvalues = ['[[:<:]]' + params.author.replace('(', '\\\\(') + '[[:>:]]', '[[:<:]]' + params.category.replace('(', '\\\\(') + '[[:>:]]'];\n\t}\n\n\tif(queryString && values) {\n\t\tdb.query(queryString, values, async (err, rows) => {\n\t\t\tif(err) {\n\t\t\t\tconsole.log(err);\n\t\t\t\treturn res.json({ fulfillmentText: 'Hmm. I might have misunderstood that 👾 Please say it more properly 😁' });\n\t\t\t}\n\n\t\t\tif(!rows.length) {\n\t\t\t\treturn res.json({ fulfillmentText: 'That book is nowhere to be found 🤷‍♀️' });\n\t\t\t}\n\n\t\t\tvar books = 'Here are the books:\\n✅ Available 🚫 Taken';\n\t\t\tvar availability;\n\t\t\tfor(var i = 0; i < rows.length; i++) {\n\t\t\t\tavailability = rows[i].borrower? '🚫' : '✅';\n\t\t\t\tbooks += '\\n\\n' + availability + ' ' + rows[i].title + '\\nAuthor: ' + rows[i].author + '\\nCategory: ' + rows[i].category;\n\t\t\t}\n\n\t\t\tawait pushCards((await getIdSource(req))[0], rows, true);\n\n\t\t\treturn res.json({ fulfillmentText: 'Here are the books 😁' });\n\t\t});\n\t} else {\n\t\treturn res.json({ fulfillmentText: 'Hmm. I might have misunderstood that 👾 Please say it more properly 😁' });\n\t}\n}\n\nexport function searchBooksByAuthor(db, req, res) {\n\tconst author = req.body.queryResult.parameters.author;\n\tconst queryString = 'SELECT * FROM book WHERE author RLIKE ? ORDER BY title';\n\n\tdb.query(queryString, '[[:<:]]' + author.replace('(', '\\\\(') + '[[:>:]]', async (err, rows) => {\n\t\tif(err) {\n\t\t\tconsole.log(err);\n\t\t\treturn res.json({ fulfillmentText: 'Hmm. I might have misunderstood that 👾 Please say it more properly 😁' });\n\t\t}\n\n\t\tif(!rows.length) {\n\t\t\treturn res.json({ fulfillmentText: 'That book is nowhere to be found 🤷‍♀️' });\n\t\t}\n\n\t\tvar books = 'Here are the books:\\n✅ Available 🚫 Taken';\n\t\tvar availability;\n\t\tfor(var i = 0; i < rows.length; i++) {\n\t\t\tavailability = rows[i].borrower? '🚫' : '✅';\n\t\t\tbooks += '\\n\\n' + availability + ' ' + rows[i].title + '\\nAuthor: ' + rows[i].author + '\\nCategory: ' + rows[i].category;\n\t\t}\n\n\t\tawait pushCards((await getIdSource(req))[0], rows, true);\n\n\t\treturn res.json({ fulfillmentText: 'Here are the books 😁' });\n\t});\n}\n\nexport function searchBooksByCategory(db, req, res) {\n\tconst category = req.body.queryResult.parameters.category;\n\tconst queryString = 'SELECT * FROM book WHERE category RLIKE ? ORDER BY title';\n\n\tdb.query(queryString, '[[:<:]]' + category.replace('(', '\\\\(') + '[[:>:]]', async (err, rows) => {\n\t\tif(err) {\n\t\t\tconsole.log(err);\n\t\t\treturn res.json({ fulfillmentText: 'Hmm. I might have misunderstood that 👾 Please say it more properly 😁' });\n\t\t}\n\n\t\tif(!rows.length) {\n\t\t\treturn res.json({ fulfillmentText: 'That book is nowhere to be found 🤷‍♀️' });\n\t\t}\n\n\t\tvar books = 'Here are the books:\\n✅ Available 🚫 Taken';\n\t\tvar availability;\n\t\tfor(var i = 0; i < rows.length; i++) {\n\t\t\tavailability = rows[i].borrower? '🚫' : '✅';\n\t\t\tbooks += '\\n\\n' + availability + ' ' + rows[i].title + '\\nAuthor: ' + rows[i].author + '\\nCategory: ' + rows[i].category;\n\t\t}\n\t\t\n\t\tawait pushCards((await getIdSource(req))[0], rows, true);\n\n\t\treturn res.json({ fulfillmentText: 'Here are the books 😁' });\n\t});\n}\n\nexport function searchBooksByTitle(db, req, res) {\n\tconst title = req.body.queryResult.parameters.title;\n\tconst queryString = 'SELECT * FROM book WHERE title RLIKE ? ORDER BY title';\n\n\tdb.query(queryString, '[[:<:]]' + title.replace('(', '\\\\(') + '[[:>:]]', async (err, rows) => {\n\t\tif(err) {\n\t\t\tconsole.log(err);\n\t\t\treturn res.json({ fulfillmentText: 'Hmm. I might have misunderstood that 👾 Please say it more properly 😁' });\n\t\t}\n\n\t\tif(!rows.length) {\n\t\t\treturn res.json({ fulfillmentText: 'That book is nowhere to be found 🤷‍♀️' });\n\t\t}\n\n\t\tvar books = 'Here are the books:\\n✅ Available 🚫 Taken';\n\t\tvar availability;\n\t\tfor(var i = 0; i < rows.length; i++) {\n\t\t\tavailability = rows[i].borrower? '🚫' : '✅';\n\t\t\tbooks += '\\n\\n' + availability + ' ' + rows[i].title + '\\nAuthor: ' + rows[i].author + '\\nCategory: ' + rows[i].category;\n\t\t}\n\n\t\tawait pushCards((await getIdSource(req))[0], rows, true);\n\n\t\treturn res.json({ fulfillmentText: 'Here are the books 😁' });\n\t});\n}\n\nexport function showAllBooks(db, req, res) {\n\tconst queryString = 'SELECT * FROM book ORDER BY title';\n\n\tdb.query(queryString, async (err, rows) => {\n\t\tif(err) {\n\t\t\tconsole.log(err);\n\t\t\treturn res.json({ fulfillmentText: 'Hmm. I might have misunderstood that 👾 Please say it more properly 😁' });\n\t\t}\n\n\t\tif(!rows.length) {\n\t\t\treturn res.json({ fulfillmentText: 'There are currently no books 🤷‍️' });\n\t\t}\n\n\t\tvar books = 'Here are the books:\\n✅ Available 🚫 Taken';\n\t\tvar availability;\n\t\tfor(var i = 0; i < rows.length; i++) {\n\t\t\tavailability = rows[i].borrower? '🚫' : '✅';\n\t\t\tbooks += '\\n\\n' + availability + ' ' + rows[i].title + '\\nAuthor: ' + rows[i].author + '\\nCategory: ' + rows[i].category;\n\t\t}\n\n\t\tawait pushCards((await getIdSource(req))[0], rows, true);\n\n\t\treturn res.json({ fulfillmentText: 'Here are all the books 😁' });\n\t});\n}\n\nexport function showAllAvailableBooks(db, req, res) {\n\tconst queryString = 'SELECT * FROM book WHERE borrower IS NULL ORDER BY title';\n\n\tdb.query(queryString, async (err, rows) => {\n\t\tif(err) {\n\t\t\tconsole.log(err);\n\t\t\treturn res.json({ fulfillmentText: 'Hmm. I might have misunderstood that 👾 Please say it more properly 😁' });\n\t\t}\n\n\t\tif(!rows.length) {\n\t\t\treturn res.json({ fulfillmentText: 'There are currently no available books 🤷‍️' });\n\t\t}\n\n\t\tvar books = 'Here are the available books:';\n\t\tfor(var i = 0; i < rows.length; i++) {\n\t\t\tbooks += '\\n\\n' + rows[i].title + '\\nAuthor: ' + rows[i].author + '\\nCategory: ' + rows[i].category;\n\t\t}\n\n\t\tawait pushCards((await getIdSource(req))[0], rows);\n\n\t\treturn res.json({ fulfillmentText: 'Here are the available books 😁' });\n\t});\n}\n\nexport async function showBorrowedBooks(db, req, res) {\n\tconst id = (await getIdSource(req))[0];\n\tconst queryString = 'SELECT * FROM book WHERE borrower = ? ORDER BY title';\n\n\tdb.query(queryString, id, async (err, rows) => {\n\t\tif(err) {\n\t\t\tconsole.log(err);\n\t\t\treturn res.json({ fulfillmentText: 'Hmm. I might have misunderstood that 👾 Please say it more properly 😁' });\n\t\t}\n\n\t\tif(!rows.length) {\n\t\t\treturn res.json({ fulfillmentText: 'You didn\\'t borrow any book 🤷‍️' });\n\t\t}\n\n\t\tvar books = 'Here are your borrowed books:';\n\t\tfor(var i = 0; i < rows.length; i++) {\n\t\t\tbooks += '\\n\\n' + rows[i].title + '\\nAuthor: ' + rows[i].author + '\\nCategory: ' + rows[i].category;\n\t\t}\n\n\t\tawait pushCards((await getIdSource(req))[0], rows);\n\t\t\n\t\treturn res.json({ fulfillmentText: 'Here are your borrowed books 😁' });\n\t});\n}\n\nexport function getStarted(db, req, res) {\n\tconst ID = req.body.originalDetectIntentRequest.payload.data.sender.id;\n\tconst name = req.body.queryResult.parameters.givenname;\n\tconst values = [ID,name+'',name+''];\n\n\n\tconst queryString = 'INSERT INTO user(id, name) VALUES(?, ?) ON DUPLICATE KEY UPDATE name = ?;';\n\t\tdb.query(queryString, values, (err, rows) => {\n\t\t\tif(err) {\n\t\t\n\t\t\t\tconsole.log(err);\n\t\t\t\treturn res.json({ fulfillmentText: 'An internal error has occured. I\\'m deeply sorry about this' });\n\t\t\t}\n\t\t\t\n\t\t\treturn res.json({ \"fulfillmentText\": 'Wow. Nice to meet you! '+name});\n\t\t});\n}"]}